# Use specific Python image that does not change over time
FROM python:3.10.6-bullseye

# Set an environment variable with the directory
# where we'll be running the app
ENV APP /app

#Set the proxy for Work
ENV http_proxy http://ep.threatpulse.net:80
ENV https_proxy http://ep.threatpulse.net:80

# Create the directory and instruct Docker to operate
# from there from now on
RUN mkdir $APP
WORKDIR $APP

ARG REPO
ARG BRANCH

RUN echo "Using repo - branch: $REPO - $BRANCH"

RUN git clone -b $BRANCH --single-branch --depth=1 https://github.com/$REPO.git ./

# Install the dependencies
RUN pip install -r requirements.txt

COPY ./docker/files/cve_search/install.sh .

RUN sed -i -e 's/\r$//' ./install.sh

RUN ["chmod", "+x", "./install.sh"]

COPY ./docker/files/cve_search/configuration.ini ./etc/configuration.ini

RUN ./install.sh

RUN rm ./install.sh

# Create a cronjob to auto update database and kill after 59 min and 50 secs
RUN echo "* 1 * * * timeout 3590 python3 /app/sbin/db_updater.py >> /etc/cron.d/e2scrub_all"

EXPOSE 5000

# run the command to start the webserver
CMD ["python", "/app/web/index.py"]
